if(typeof samo==='undefined'){var samo={version:'1.01',search_datasource:'?'};}
samo.jQuery=jQuery.noConflict(true);(function($){var
MAX_NO_HIDDEN_OPTIONS={TOUR:8,HOTEL:6},HOTEL_PREVIEW_WIDTH=200,HOTEL_PREVIEW_HEIGHT=130,REQUEST_TIMEOUT=60000,SCROLL_TO_TIME=600,SCROLL_TO_TOP_TIME=300,DEFAULT_SCROLL_TO_TIME=1000,TEXT_FILTER_TIMEOUT=200,CACHE_TTL=900000,HIDDEN_OPTIONS_TOOLTIP_TIMEOUT=50,ADVANCED_INFO_TIMEOUT=1000,ACCESS_DENIED_ERROR_CODE=-999,MAX_MINI_CHECKBOX_COUNT=5,THREAD_TIMEOUT=0,TOOLTIP_OVER_TIMEOUT=500,TOOLTIP_OVER_TIMEOUT_SHORT=100,MAX_HOTEL_INFO_DESCRIPTION_LEN=600,TAB_CHANGE_SPEED=300,MAX_NIGHTS=29,MAX_DAYS_OFFSET=3,MAX_ADULT=9,MAX_CHILD=10,PRICE_NEXT_SHOW_TIMEOUT=100,HIDDEN_OPTIONS_PER_COLUMN=10,NOTIFY_TTL=30000,MAX_OPTIONS_PER_LIST=2,ADVANCED_HOTEL_INFO_COUNT_PER_REQUEST=20,LOADING_PROGRESS_TIMEOUT=30,LOADING_PROGRESS_SPEED=200;samo.search_datasource=$('#SAMO_SEARCH').data('samo-datasource');samo.search_datatarget=$('#SAMO_SEARCH').data('samo-datatarget');samo.search_datasearchurl=$('#SAMO_SEARCH').data('samo-searchurl');$.ajaxSetup({error:function(xhr,status,e){$.event.trigger('ajaxStop');var error='';if('timeout'==status){error='Превышено время ожидания от сервера. Повторите запрос позже.';}else{error='Ошибка обработки данных.';}
if(samo.view){samo.view.error(error);}else{alert(error);}},timeout:REQUEST_TIMEOUT,scriptCharset:'utf-8',dataType:'jsonp',type:'POST'});$.ajaxPrefilter("jsonp",function(options){options.global=true;});$.jsonLoad=function($get_params,$params,$callback,$error){$params=$params||{};$callback=$callback||function(){};$get_params.version='1.01';$.ajax({url:samo.search_datasource+$.param($get_params),data:$params,success:$callback});};samo.datepicker=function(name,data){if(data==false){name.dpSetValidDates('0');}else{name.dpSetValidDates(data[2]).dpSetStartDate(data[1]).val(data[0]).dpSetSelected(data[0]);}};samo.search=function(){var self=this;self.notifyTimer=false;self.loadOperatorsData=false;self.error=function(text,code){if(code==ACCESS_DENIED_ERROR_CODE){$('#FORM_BLOCKER').show();self.updateBlockers();return;}
if(!self._error){self._error=new samo.popup();}
text='<div class="samo_error">'+text+'</div>';self._error.set(text);self._error.show();};self.notify=function(text){if(self.notifyTimer){clearTimeout(self.notifyTimer)}
$('#SAMO_NOTIFY').html($('#SEARCH_NOTIFY_TMPL').tmpl({text:text})).fadeIn();self.notifyTimer=setTimeout(self.closeNotify,NOTIFY_TTL);};self.closeNotify=function(){$('#SAMO_NOTIFY').hide();};self.clearParams=function(params){$.each(params,function(i,e){if(e===null||(i=='TOWNTO'||i=='OPERATORS'||i=='STARS'||i=='MEAL'||i=='HOTELS')&&e==0){delete params[i];}});return params;};self.cloneObj=function(obj){return $.extend(true,{},obj);};self.doRequest=function(action,params,hidePreloader){samo.removeOldToolTips();if(hidePreloader){self.hidePreloader=true;}else{self.preloaderShow();}
params=params?params:{};params.AGENT=params.uid=self.agent;params.async_mode=self.async_mode;params.version='1.01';if(self.tab=='HOTEL'){params.PACKETTYPE=1;params.PACKETTYPEMODE=1;}else if(self.tab=='TOUR'){params.PACKETTYPEMODE=0;}else if(self.tab=='EXCURSION'){params.PACKETTYPEMODE=2;}
if(!params.action){params.action=action;}
params=self.clearParams(params);var now=+(new Date());var cacheKey=$.param(params);var callback=function(data){if(data){if(data.error){self.error(data.error,data.code);return;}
if(typeof data.CURRENTOPERATOR!='undefined'){self.currentOperator=data.CURRENTOPERATOR;}
if(typeof data.PRESETTINGS!='undefined'){self._preSettings=data.PRESETTINGS;}
if(typeof data.OPERATORS!='undefined'&&data.OPERATORS.length){self.lastOperators=[];$.each(data.OPERATORS,function(i,e){self.lastOperators.push(e.id);});}
if(typeof data.NOTIFY!='undefined'&&data.NOTIFY){self.notify(data.NOTIFY);}
self.httpCache[cacheKey]={data:self.cloneObj(data),datetime:now};var func='_callback_'+action;if(self[func]){self[func](data);}
if(self.async_mode&&action=='prices'){self.pricesProgressRun(data);}}};if(self.httpCache[cacheKey]&&self.httpCache[cacheKey].datetime+self.httpCacheTTL>now){self.hidePreloader=false;self.preloaderHide();callback(self.cloneObj(self.httpCache[cacheKey].data));return;}
if(action=='prices'){self.loadingProgress.start();}
$.jsonLoad(params,null,function(data){self.loadingProgress.stop();self.setServerSettings(data);callback(data);});};self.preloaderHide=function(){$('#preloader').css('display','none');};self.preloaderShow=function(){$('#preloader').css('display','block');};self.loadingProgress={use:false,timer:false,percent:0,start:function(){self.loadingProgress.use=self.getSetting('USE_PRICES_LOADING_PROGRESS',false,true);if(!self.loadingProgress.use){return false;}
self.loadingProgress.stop();$('#preloader .samo_std_loader').hide();var $p=$('#SAMO_LOADING_PROGRESS');var timeout=self.getSetting('PRICES_LOADING_PROGRESS_TIMEOUT',true,true)||LOADING_PROGRESS_TIMEOUT;timeout*=1000;var t=0;var lastP=0;var PId2=Math.PI/2;var PIu15=Math.PI*1.5;self.loadingProgress.timer=setInterval(function(){t+=LOADING_PROGRESS_SPEED;var percent=(Math.cos(t/timeout*PId2+PIu15))*100;lastP=percent;if(!self.loadingProgress.setPercent(percent)){self.loadingProgress.stop();}},LOADING_PROGRESS_SPEED);$p.show();},stop:function(){if(!self.loadingProgress.use){return false;}
self.loadingProgress.setPercent(0);$('#preloader .samo_std_loader').show();var $p=$('#SAMO_LOADING_PROGRESS').hide();if(self.loadingProgress.timer){clearInterval(self.loadingProgress.timer);}},setPercent:function(percent){if(!self.loadingProgress.use){return false;}
var $p=$('#SAMO_LOADING_PROGRESS');if(percent>=100){percent=100;}
var $percent=$p.find('.samo_progress_percent');var $bar=$p.find('.samo_progress_bar');$percent.css('width',Math.round(percent/100*$bar.width())+'px');self.loadingProgress.percent=percent;$p.find('.samo_progress_percent_text').html('Идет поиск: <strong>'+Math.round(percent)+'%</strong>');return percent<100;}};self.getDataValues=function(name){if(self.data[name]){return self.data[name].values;}
return null;};self.makeChosen=function(selector,data,allowTextValue){var $obj=$(selector);if($obj.is('[data-samo-chosened]')){return false;}
$obj.attr('data-samo-chosened',1);$obj.css('width','400px');$obj.html('');$obj.append('<option value=""></option>');if(data){var d;for(var ind in data){d=data[ind];$obj.append($('<option></option>').val(d.id).html(d.name));}}
$obj.chosen({no_results_text:allowTextValue?'Искать':'Не найдено'});if(allowTextValue){$obj.on('chosen:hiding_dropdown',function(e,c){var $this=$(this);var $chosen=$('#'+this.id+'_chosen');var $chosenInput=$chosen.find('input');var val=$chosenInput.val();var $opt=$this.find('option[data-samo-added]');var wasVal=$this.val();if($(this).attr('data-samo-selected')){val='';}
if(val){val=self.stripTags(val);if(!$opt.size()){$opt=$('<option data-samo-added></option>');$this.append($opt);}
$opt.val(val).html('Искать "<strong>'+val+'</strong>"');if(-1==$.inArray(val,wasVal)){wasVal=wasVal?wasVal:[];wasVal.push(val);}
$this.val(wasVal);}else{if(-1==$.inArray($opt.val(),$this.val())){$opt.remove();}}
$(this).removeAttr('data-samo-selected');$this.trigger('chosen:updated');}).on('chosen:showing_dropdown',function(){var $opt=$(this).find('option[data-samo-added]');if(-1==$.inArray($opt.val(),$(this).val())){$opt.remove();}}).on('chosen:selected',function(){$(this).attr('data-samo-selected','1');});$('#'+$obj.get(0).id+'_chosen input').on('keyup',function(e){if(e.keyCode==13){$obj.trigger('chosen:hiding_dropdown');}});}};self.stripTags=function(str){return str.replace(/<\/?[^>]+>/gi,'');};self.setServerSettings=function(data){if(data._SETTINGS){for(var ind in data._SETTINGS){self._settings[ind]=data._SETTINGS[ind];}
$.each(self._settings,function(i,e){if(typeof samo.settings.search['srv_'+i]!='undefined'){self._settings[i]=samo.settings.search['srv_'+i];}});}};self.init=function(data){self._settings.SingleOperatorMode=self._settings.SingleOperatorMode===null?0:parseInt(self._settings.SingleOperatorMode);if(!self.miniMode&&!self.inited){var formTabs=self.getSetting('FormTabs',true);if(formTabs){if(typeof formTabs=='string'){formTabs=formTabs.split(',');$.each(formTabs,function(i,e){formTabs[i]=$.trim(e.toUpperCase());});}}else{formTabs=['TOUR'];}
$('.samo_tab').each(function(i,e){var name=e.id.replace(/SAMO_TAB_/,'');if($.inArray(name,formTabs)==-1){$('#SAMO_TAB_'+name).remove();}});if(self.$container.find('.samo_tab').size()>1){self.$container.find('.samo_tab').addClass('samo_tab_visible');}
var tab=self.getParams.TAB;self.setTab(tab?tab:$('.samo_tab:first'));}
self.updateSearchData(data);self.resetChilds();self.inited=true;if(data.PRICES){self.updateSearchResults(data.PRICES);}};self.resetSearchParams=function(){if(!self.miniMode){self.toHotelList();}
self.HOTEL_INFO={};self.OPERATOR_SUPPORT={};self.INSTALLMENTS={};$.each(['HOTELS','TOWNTO','STARS','MEAL'],function(i,e){if(!self.miniMode){$('#'+e+'_FILTER').val('');$('#'+e+' input[type=checkbox]').removeAttr('checked');}else{$('#'+e).val(0);}});if(self.inited&&self.data.HOTELS){$.each(self.data.HOTELS.values,function(i,e){self.data.HOTELS.values[i].selected=false;});}
self.calcHiddenOptions();self.drawSamoCheckBoxes();};self.calcHiddenOptions=function(){$.each(['MEAL','STARS','OPERATORS'],function(i,e){var $l=$('#show_'+e+'_hidden_options');var m=$('#'+e).attr('data-samo-list-name');var $checked=$('#'+e+'_hidden_options input:checked');var c=$checked.size();var title=[];var html='';if(c){$.each($checked,function(i,e){title.push($(e).parent().text());});title=title.join(', ');}else{title=m;}
if(!m){html='Прочие '+(c?'(выбрано: '+c+') ':'')+'&raquo;';}else{if(c>MAX_OPTIONS_PER_LIST){html='Выбрано: '+c;}else{html=title;title='';}}
$l.html(html);if(title){$l.attr('title',title);}else{$l.removeAttr('title');}});};self.drawSamoCheckBoxes=function($trg){$trg=$trg?$trg:$('.samo_checkbox_mini_container label',self.$container);$trg.each(function(i,e){var $e=$(e);if($e.find('input:checked').size()){$e.addClass('samo_checkbox_mini_container_on');}else{$e.removeClass('samo_checkbox_mini_container_on');}});};self.setElementData=function(el,data,localUpdate){var name=el;var _name='';var _alias='';el=$('#'+el);var html='';var elHtml='';var hiddenHtml='';var htmlCount=0;var hiddenHtmlCount=0;var isHotels=name=='HOTELS';var isMeal=name=='MEAL';var isStar=name=='STARS';var isTownFrom=name=='TOWNFROMINC';var isState=name=='STATEINC';var isOperator=name=='OPERATORS';var values=data.values;var isSelect=el.is('select');if(!localUpdate&&isSelect&&data.any&&values){if(isHotels){values[0]={id:0,name:data.any,visible:true};}else{values.unshift({id:0,name:data.any,visible:true});}}
if(localUpdate&&!self.hotelsSets){localUpdate=false;}
if(!localUpdate&&isHotels){values=data.sorted;if(data.any&&isSelect&&values[0]!=0){values.unshift(0);}}
values=values?values:{};if(isSelect||el.is('div')){if(localUpdate){if(isSelect&&typeof values=='number'){$(el).find('option[value='+values+']').attr('selected','selected');}else{$.each(values,function(i,e){if(e.el){e.el.style.display=(e.visible||i==0)?'block':'none';}});}}else{if(isTownFrom||isState){var lastGroup=false;if(isState){var isRated=false;$.each(values,function(i,e){if(e.rating){isRated=true;values[i].rating=true;}else{values[i].rating=false;}});}}
if($(el).is('.samo-chosen')){self.makeChosen('#'+name,values,name=='GEOPOINT');}else{$.each(values,function(i,e){if(isHotels){e=data.values[e];}
_name=e.name;if(isHotels&&e.id){_alias=_name;}else{_alias=e.alias?e.alias:_name;}
if(isSelect){if(isTownFrom){if(lastGroup!=e.state){html+=(lastGroup?'</optgroup>':'')+'<optgroup label="'+e.stateName+'">';}
lastGroup=e.state;}else if(isState&&isRated){if(lastGroup!=e.rating){html+=(lastGroup===false?'</optgroup>':'')+'<optgroup label="'+(e.rating?'Популярные':'Остальные')+'">';}
lastGroup=e.rating;}
html+='<option value="'+e.id+'"'+(e.selected==1?' selected="selected"':'')+' style="display: '+(e.visible?'block':'none')+'" id="'+name+'_samo_element_'+e.id+'">'+_name+'</option>';}else{var useBasic=isMeal||isStar;if(isStar){var s=self.decodeStar(_name);if(s){_name='<span class="samo_back_star">'+s+'</span>';_alias='';}}
var toHtml=true;if(toHtml&&useBasic&&htmlCount>=MAX_NO_HIDDEN_OPTIONS[self.tab]){toHtml=false;}
elHtml='<label title="'+_alias+'" id="'+name+'_samo_element_'+e.id+'" style="display: '+(e.visible?'block':'none')+'; position: relative;"><input type="checkbox"'+(e.selected==1?'checked="checked"':'')+' value="'+e.id+'"'+(isHotels?' class="samo_hotel_item"':'')+'>'+_name;if(isStar||isMeal||isOperator){elHtml+='<div class="samo_checkbox_mini_limiter">&nbsp;</div>';}
elHtml+='</label>';if(isOperator){toHtml=false;}
if(toHtml){html+=elHtml;htmlCount++;}else{hiddenHtml+=elHtml;hiddenHtmlCount++;if(hiddenHtmlCount%HIDDEN_OPTIONS_PER_COLUMN==0){hiddenHtml+='</td><td valign="top">';}}}});}
if(isTownFrom||isState){html+='</optgroup>';}}
if(!localUpdate){if(!isHotels){if(html==''&&hiddenHtml!=''&&!isOperator){html=hiddenHtml;hiddenHtml='';}
if(hiddenHtml){hiddenHtml='<table><tr><td valign="top">'+hiddenHtml+'</td></tr></table>';var listName=el.attr('data-samo-list-name');if(!listName){html+='<br>';}
listName=listName?listName:'Прочие &raquo;';html+='<a href="javascript:void(0);" id="show_'+name+'_hidden_options" class="show_hidden_options">'+listName+'</a>';html+='<div style="position: relative; height: 1px; width: 1px; margin: 0px; padding: 0px;"><div class="samo_hidden_options" id="'+name+'_hidden_options">'+hiddenHtml+'<a class="samo_hidden_options_close" href="javascript:void(0);">Закрыть</a></div><br></div>';}}
if(isHotels){self.toThread(function(){el.html(html);$.each(self.data[name].values,function(i,e){self.data[name].values[i].el=document.getElementById(name+'_samo_element_'+e.id);if(self.data[name].values[i].selected){self.toHotelList(self.data[name].values[i].id);}});self.hotelsSets=true;});}else{if(!el.is('.samo-chosen')){if(isSelect){el.html('');}
el.html(html);}}
if(!isHotels){if(typeof useBasic!=undefined&&htmlCount<MAX_MINI_CHECKBOX_COUNT){el.find('label').addClass('samo_max_mini_checkbox');}}}}else if(el.is('input.date')){if(values==false){el.dpSetValidDates('0');}else{el.dpSetValidDates(values.available).dpSetStartDate(values.start).val(values.selected).dpSetSelected(values.selected);}}else{el.val(values);if((name=='COSTMIN'||name=='COSTMAX')&&parseInt(values)){self.showAdvanced();}
if(name=='AGES'){self.resetChilds(values);}
if(name=='STOPSALE'||name=='FREIGHT'){if(parseInt(values)){$('#'+name).attr('checked','checked');}else{$('#'+name).removeAttr('checked');}}
if(name=='PACKETTYPE'){self.resetPacketType(values);}}};self.hideHiddenOptions=function(){if(self.loadOperatorsData&&$('#OPERATORS_hidden_options:visible').size()){self.changeOperators();}
$('.samo_hidden_options',self.$container).stop().slideUp('fast');};self.showHiddenOptions=function(name,hide){var vis=$('#'+name+'_hidden_options:visible').size()>0;self.hideHiddenOptions();if(!vis){self.hiddenClicked=true;$('#'+name+'_hidden_options').stop().slideDown('fast');}};self.updateSearchData=function(data,localUpdate){var i=0;if(data&&!localUpdate){var _adult=data.ADULT,_child=data.CHILD,_nightsFrom=data.NIGHTS_FROM,_nightsTill=data.NIGHTS_TILL,_daysOffset=data.DAYS_OFFSET?data.DAYS_OFFSET:(self.data.DAYS_OFFSET._default?self.data.DAYS_OFFSET._default:0);if(typeof _nightsFrom=='object'){_nightsFrom=false;}else{data.NIGHTS_FROM=[];}
if(typeof _nightsTill=='object'){_nightsTill=false;}else{data.NIGHTS_TILL=[];}
if(typeof _adult=='object'){_adult=false;}
if(typeof _child=='object'){_child=false;}
if(typeof _daysOffset=='object'){_daysOffset=false;}else{data.DAYS_OFFSET=[];}
if(_adult!==false){if(typeof _adult!=='undefined'||!self.inited){data.ADULT=[];for(i=1;i<=MAX_ADULT;i++){data.ADULT.push({id:i,name:i,selected:i==_adult});}}}
if(_child!==false){if(typeof _child!=='undefined'||!self.inited){data.CHILD=[];for(i=0;i<=MAX_CHILD;i++){data.CHILD.push({id:i,name:i,selected:i==_child});}}}
if(_nightsFrom!==false||_nightsTill!==false){for(i=1;i<=MAX_NIGHTS;i++){if(_nightsFrom!==false){data.NIGHTS_FROM.push({id:i,name:i,selected:i==_nightsFrom});}
if(_nightsTill!==false){data.NIGHTS_TILL.push({id:i,name:i,selected:i==_nightsTill});}}}
if(_daysOffset!==false){for(i=0;i<=MAX_DAYS_OFFSET;i++){data.DAYS_OFFSET.push({id:i,name:i,selected:i==_daysOffset});}}
if(data.TOWNFROM){data.TOWNFROMINC=data.TOWNFROM;delete data.TOWNFROM;}
if(data.STATE){data.STATEINC=data.STATE;delete data.STATE;}
if(data.CURRENCY){data.CURRENCYINC=data.CURRENCY;delete data.CURRENCY;}}
if(data){var names=['NIGHTS_TILL','NIGHTS_FROM','ADULT','CHILD','CURRENCY'];for(var index in names){if(typeof data[names[index]]=='number'){self.data[names[index]].values=data[names[index]];}}}
$.each(data,function(i,e){var isHotels=i=='HOTELS';if(isHotels&&e){var sorted=[];if(self.miniMode){var tmp={'0':{name:'',selected:0}};}else{var tmp={};}
$.each(e,function(_i,_e){tmp[_e.id]=_e;sorted.push(_e.id);});e=tmp;}
if(self.data[i]){self.data[i].values=e?e:[];if(!localUpdate){if(isHotels){var srt=[];}
$.each(self.data[i].values,function(_i,_e){self.data[i].values[_i].visible=true;if(self.data[i].values[_i].name){self.data[i].values[_i].name=self.data[i].values[_i].name.toString().replace(/</g,'&gt;').replace(/"/g,'&quot;');if(isHotels){if(!self.data[i].values[_i].nameSets){self.data[i].values[_i].name+=' '+self.data[i].values[_i].star+(self.data[i].values[_i].star==parseInt(self.data[i].values[_i].star)?'*':'');self.data[i].values[_i].nameSets=true;}
srt.push([self.data[i].values[_i].id,self.data[i].values[_i].name.toLowerCase()]);}}});if(isHotels){self.data[i].sorted=sorted;}}}});$.each(data,function(i,e){if(self.data[i]){self.setElementData(i,self.data[i],localUpdate);}});if(!localUpdate&&!self.inited){self.setFilter();}
if(!localUpdate){if(data.TOUR&&data.TOUR.length){self.showHide('tour_select',self.getSetting('SHOWTOURSELECT'));}else{self.showHide('tour_select',false);}}
if(!self.inited&&!localUpdate){self.showHide('instruction',data.INSTRUCTION);}
if(!localUpdate&&!self.miniMode){self.checkAny();}
self.calcHiddenOptions();self.drawSamoCheckBoxes();};self._callback_init=function(data){self.init(data);self.setPreSettings(data);};self.setPreSettings=function(data){if(!self._preSettings)return false;var t=self.getSearchParams(false,false,'TOWNFROMINC');var s=self.getSearchParams(false,false,'STATEINC');var wasMeal=false;var wasStars=false;var wasTownTo=false;var wasCheckin=false;var wasChild=false;var res={};var operator=self.currentOperator;if(!operator){operator=parseInt(self.getSearchParams(false,false,'OPERATORS'));}
if(!operator&&self.lastOperators.length&&self.lastOperators.length==1){operator=self.lastOperators[0];}
operator=operator?operator:0;$.each(self._preSettings,function(i,e){if(self.data[i]){if(typeof e=='string'){e=e.split(',');$.each(e,function(gg,kk){e[gg]=$.trim(kk);});}
var val=e;if(i=='COSTMIN'||i=='COSTMAX'||i=='STOPSALE'||i=='FREIGHT'||i=='PACKETTYPE'){self.data[i].values=val[0];}else if(i=='CHECKIN_BEG'||i=='CHECKIN_END'){self.data[i].values.selected=val[0];}else{if(i=='AGES'){$.each(val,function(__i,__e){self.data[i].values.push(__e);})}
$.each(self.data[i].values,function(__i,__e){self.data[i].values[__i].selected=$.inArray(''+self.data[i].values[__i].id+'',val)!=-1;});}
self.setElementData(i,self.data[i]);if(i=='STARS'){wasStars=true;}
if(i=='MEAL'){wasMeal=true;}
if(i=='TOWNTO'){wasTownTo=true;}
if(i=='CHECKIN_BEG'||i=='CHECKIN_END'){wasCheckin=true;}
if(i=='CHILD'||i=='AGES'){wasChild=true;}}});if(wasStars||wasMeal||wasTownTo){setTimeout(function(){if(wasTownTo||wasStars){self.setFilter();}
self.checkAny();self.calcHiddenOptions();self.drawSamoCheckBoxes();},THREAD_TIMEOUT+100);}
if(wasCheckin){self.checkCheckin();}
if(wasChild){self.resetChilds();}};self._callback_price_next=function(data){var key='__next_price_'+self.nextId;if(!self[key]){var colspan=0;$.each($('.samo_price_row_'+self.nextId+':visible > td'),function(i,e){var c=$(e).attr('colspan');if(c){c=parseInt(c);}
colspan+=c?c:1;});self[key]=[];var $rows=$('.samo_price_row_'+self.nextId);var visInd=0;$.each($rows,function(i,e){var $row=$(e);var ind=$row.is('.show_hide_full_result')?1:0;if($row.is(':visible')){visInd=ind;}
self[key][ind]=$('<tr class="'+(!ind?'show_hide_short_result':'show_hide_full_result')+'" style="display:none;"><td colspan="'+colspan+'"></td></tr>');self[key][ind].data('samo-next-id',self.nextId);$row.after(self[key][ind]);if(self.tab=='HOTEL'){var rooms={};$.each(data.PRICES_NEXT,function(i,e){e.bronUrl=self.makeBronUrl(e);if(!rooms[e.groupId]){rooms[e.groupId]={room:[],htplace:[],prices:[],description:[],meal:[]};}
rooms[e.groupId].prices.push(e);if(e.room){rooms[e.groupId].room.push(e.room);}
if(e.htplace){rooms[e.groupId].htplace.push(e.htplace);}
if(e.description){rooms[e.groupId].description.push(e.description);}
if(e.meal){rooms[e.groupId].meal.push(e.meal);}});$.each(rooms,function(i,e){$.each(['room','htplace','description','meal'],function(_i,_e){rooms[i][_e]=$.unique(rooms[i][_e]);rooms[i][_e]=rooms[i][_e].join(' / ');});});data.ROOMS=rooms;}
$.each(data.PRICES_NEXT,function(i,e){data.PRICES_NEXT[i].bronUrl=self.makeBronUrl(e);});data.priceShow=self.getSetting('PRICESHOW');self[key][ind].find('td:first').html($('#'+self.tab+'_NEXT_PRICE_TMPL').tmpl(data).html());self[key][ind].find('.price_next_container_close').data('samo-next-id',self.nextId);if(self[key][visInd]){self[key][visInd].show();}
self[key][ind].find('.price_next_container').slideDown(PRICE_NEXT_SHOW_TIMEOUT,function(){$row.scrollTo(SCROLL_TO_TIME)});});}else{var ind=self.resultsShortView?0:1;self[key][ind].show().find('.price_next_container').slideDown(PRICE_NEXT_SHOW_TIMEOUT,function(){$('.samo_price_row_'+self[key][ind].data('samo-next-id')+':visible').scrollTo(SCROLL_TO_TIME);});}};self._callback_advanced_info=function(data){if(data&&data.HOTEL_INFO){$.each(data.HOTEL_INFO,function(i,e){if(e){data.HOTEL_INFO[i].starNumber=self.decodeStar(e.star);}});self.HOTEL_INFO=$.extend(self.HOTEL_INFO,data.HOTEL_INFO);self.OPERATOR_SUPPORT=$.extend(self.OPERATOR_SUPPORT,data.OPERATOR_SUPPORT);self.INSTALLMENTS=$.extend(self.INSTALLMENTS,data.INSTALLMENTS);}
if(self.advInfoFuncs[++self.advInfoFuncsIndex]){self.advInfoFuncs[self.advInfoFuncsIndex]();}else{self.advInfoFuncs=[];self.advInfoFuncsIndex=0;}};self._callback_townfrominc=function(data){self.updateSearchData(data);self.setPreSettings(data);};self._callback_stateinc=function(data){self.updateSearchData(data);self.setPreSettings(data);};self._callback_operator=function(data){self.updateSearchData(data);self.setPreSettings(data);};self._callback_prices=function(data){self.updateSearchResults(data);};self._callback_instruction=function(data){if(!self.instruction){self.instruction=new samo.popup(data.instruction);}
self.instruction.show();};self.getSetting=function(name,serverSettings,any){if(serverSettings||any){if(typeof self._settings[name]!='undefined'&&self._settings[name]!==null){return self._settings[name];}}
if(!serverSettings||any){if(typeof samo.settings.search[name]!='undefined'&&samo.settings.search[name]!==null){return samo.settings.search[name];}}
return null;};$.fn.scrollTo=function(time){if($(this).size()&&$(this).is(':visible')){$('html, body').animate({scrollTop:$(this).offset().top},time?time:DEFAULT_SCROLL_TO_TIME);}
return $(this);};self.decodeStar=function(star){var m=star.match(/^[1-5]{1}\s*\**$/);var s=false;if(m){s=m[0];}else{m=star.match(/^\*{1,5}$/);if(m){s=star.length;}}
return s?parseInt(s):false;};self.clearSearchResults=function(){$('#SEARCH_RESULTS').html('');};self.makeBronUrl=function(price){if(price.id){return samo.search_datatarget+encodeURIComponent(price.id)+'&TAB='+self.tab;}
return'';};self.updateSearchResults=function(data){self.toThread(function(){data.SINGLEOPERATOR=data.SINGLEOPERATOR===null?0:parseInt(data.SINGLEOPERATOR);var firstPage=data.PAGE==1;var $res=$('#SEARCH_RESULTS');if(firstPage){$res.html('').hide();}
var $n=$('.samo_next',$res);if($n.is('td')){$n=$n.parent();}
$n.remove();var showInstallment=$('#SEARCH_RESULTS .show_hide_installment:visible').size()?true:false;var advHotelInfo=[];var advOperatorSupport=[];var advInstallments=[];if(data.CHANGE_FIELDS){self.updateSearchData(data.CHANGE_FIELDS,true);}
$.each(data.PRICES,function(i,e){var index=e.hotelKey+'_'+e.operatorKey+'_'+e.isOperatorHotelKey;data.PRICES[i].hotelInfoKey=index;if(!self.HOTEL_INFO[index]){advHotelInfo.push(index);}
index=data.PRICES[i].installmentId;if(index&&!self.INSTALLMENTS[index]){advInstallments.push(index);}
index=data.PRICES[i].operatorKey;if(index&&!self.OPERATOR_SUPPORT[index]){advOperatorSupport.push(index);}
data.PRICES[i].starNumber=self.decodeStar(e.star);if(data.PRICES[i].price<data.PRICES[i].discoCost){data.PRICES[i].price=data.PRICES[i].discoCost;}
var ps=data.PRICES[i].placeStatus;var pt=self.getSearchParams(false,false,'PACKETTYPE');var advFCN='бизнес';var advPI=2;var advPO=2;if(pt==1){data.PRICES[i].noFreight=(data.PRICES[i].id?0:1);}else{var passed=false;var found=false;var n='';for(var __i=0;__i<ps.length;__i++){if(ps[__i]['in']!=2&&ps[__i].out!=2){passed=true;n=$.trim(ps[__i]['class'].toLowerCase());if(n!='эконом'){found=true;advPI=ps[__i]['in'];advPO=ps[__i]['out'];advFCN=n;break;}}}
if(!found){advPI=ps[1]['in'];advPO=ps[1]['out'];}
advFCN=advFCN.charAt(0).toUpperCase()+advFCN.slice(1);data.PRICES[i].noFreight=!passed;data.PRICES[i].placeStatus[1]['in']=advPI;data.PRICES[i].placeStatus[1]['out']=advPO;data.PRICES[i].placeStatus[1]['class']=advFCN;}
data.PRICES[i].advFlightClassName=advFCN;if(typeof data.PRICES[i].townFromKey=='undefined'){data.PRICES[i].townFromKey=$('#TOWNFROMINC').val();}
if(typeof data.PRICES[i].stateKey=='undefined'){data.PRICES[i].stateKey=$('#STATEINC').val();}
if(typeof data.PRICES[i].child=='undefined'){data.PRICES[i].child=$('#CHILD').val();}
if(typeof data.PRICES[i].adult=='undefined'){data.PRICES[i].adult=$('#ADULT').val();}
if(typeof data.PRICES[i].stopSale=='undefined'){data.PRICES[i].stopSale=0;}
if(typeof data.PRICES[i].momentConfirm=='undefined'){data.PRICES[i].momentConfirm=0;}
if(data.PRICES[i].stopSale==1||data.PRICES[i].noFreight==1){data.PRICES[i].momentConfirm=0;}
if(!data.PRICES[i].id){data.PRICES[i].installmentPrice=false;}else{data.PRICES[i].bronUrl=self.makeBronUrl(data.PRICES[i]);}
if(!showInstallment&&data.PRICES[i].installmentPrice&&data.PRICES[i].id){showInstallment=true;}});data.shortView=self.resultsShortView;data.priceShow=self.getSetting('PRICESHOW');data.showTo=parseInt(self.getSetting('ShowTo',true));data.showTour=parseInt(self.getSetting('ShowTour',true));if(!data.showTour){data.showTour=parseInt(self.getSetting('SHOWTOUR'));}
data.showSpo=parseInt(self.getSetting('SHOWSPO'));data.tab=self.tab;var found=data.PRICES.length;if(found){data.targetUrl=samo.search_datatarget;}
$('#SEARCH_RESULTS .samo_new_results').remove();$('#SEARCH_RESULTS'+(found?'':'_NO_PRICES')+'_TMPL').tmpl(data).appendTo($res);if(self.getSetting('SHOWGOTOTOPBTN')){$('#GOTOTOP').remove();}
if(found){self.showHide('installment',showInstallment);}
$res.show();var $r=$('.samo_scroll_to:visible',$res).removeClass('samo_scroll_to');if($('#SAMO_NOTIFY:visible').size()){$r=$('#SAMO_NOTIFY:visible');}
$r.scrollTo(SCROLL_TO_TIME);if(found){self.updateBlockers();advInstallments=$.unique(advInstallments).join(',');advOperatorSupport=$.unique(advOperatorSupport).join(',');advHotelInfo=$.unique(advHotelInfo);var hc=Math.ceil(advHotelInfo.length/ADVANCED_HOTEL_INFO_COUNT_PER_REQUEST);self.advInfoFuncs=[];self.advInfoFuncsIndex=0;for(var i=0;i<hc;i++){self.advInfoFuncs.push((function(_i){return function(){if(_i){advInstallments='';advOperatorSupport='';}
self.advancedInfo({INSTALLMENTS:advInstallments,OPERATOR_SUPPORT:advOperatorSupport,HOTEL_INFO:advHotelInfo.slice(_i*ADVANCED_HOTEL_INFO_COUNT_PER_REQUEST,_i*ADVANCED_HOTEL_INFO_COUNT_PER_REQUEST+ADVANCED_HOTEL_INFO_COUNT_PER_REQUEST).join(',')});}})(i));}
setTimeout(self.advInfoFuncs[0],ADVANCED_INFO_TIMEOUT);}});};self.advancedInfo=function(params){self.doRequest('advanced_info',params,true);};self.toThread=function(func){setTimeout(func,THREAD_TIMEOUT);};self.updateBlockers=function(){$('.samo_no_bron_blocker:visible',self.$container).each(function(){var $tr=$(this).parent().parent().parent();var $td=$(this).parent().parent();var trHeight=$td.outerHeight(),tdHeight=$td.outerHeight();var pos1=$tr.offset();var pos2=$(this).offset();var left=(pos2.left-pos1.left);var top=(pos2.top-pos1.top);var height=trHeight>tdHeight?trHeight:tdHeight;var width=$tr.outerWidth();$(this).css({height:height,width:width});if(left){$(this).css('left',-left);}
if(top){$(this).css('top',-top);}});};self.redirect=function(url,selfWindow){if(selfWindow){window.location.href=url;}else{window.open(url);}};self.setFilter=function(ev){var upd={};var cb=ev?$(ev.target).is('input[type=checkbox]'):false;var refindHotel=false;var tt=[];var ss=[];if(self.inited){if(self.miniMode){var tmp=$('#TOWNTO').val();if(typeof tmp!='undefined'&&tmp!=0){tt=[parseInt(tmp)];}
tmp=$('#STARS').val();if(typeof tmp!='undefined'&&tmp!=0){ss=[parseInt(tmp)];}}else{$('#TOWNTO input:checked').each(function(i,e){tt.push(parseInt($(e).val()));});$('#STARS input:checked').each(function(i,e){ss.push(parseInt($(e).val()));});}}else{if(self.data.STARS&&self.data.STARS._default){ss=self.data.STARS._default.split(',');}
if(ss.length){$.each(ss,function(i,e){ss[i]=parseInt(e);});}
if(self.data.TOWNTO&&self.data.TOWNTO._default){tt=self.data.TOWNTO._default.split(',');}
if(tt.length){$.each(tt,function(i,e){tt[i]=parseInt(e);});}}
$.each(self.data.HOTELS.values,function(i,e){var v=false;if(tt.length||ss.length){v=!tt.length||$.inArray(parseInt(e.townKey),tt)>-1;if(v&&ss.length){v=$.inArray(parseInt(e.starKey),ss)>-1;}
if(v!==self.data.HOTELS.values[i]){upd.HOTELS=true;}}else{v=true;upd.HOTELS=true;}
self.data.HOTELS.values[i].visible=v;});if(!self.miniMode){if(cb&&$('#HOTELS_FILTER').val()!=''){refindHotel=true;}
if((!cb&&self.inited)||refindHotel){if(refindHotel){e='HOTELS';}else{if(ev){e=$(ev.target).attr('id').replace(/_FILTER/,'');}else{e='HOTELS';}
if(e=='HOTELS'){refindHotel=true;}}
upd[e]=true;var val=$('#'+e+'_FILTER').val().toLowerCase();$.each(self.data[e].values,function(_i,_e){var v=false,_v=refindHotel?self.data[e].values[_i].visible:true;if(val!=''){if(_e.name.toLowerCase().indexOf(val)>-1){v=_v;}}else{v=_v;}
self.data[e].values[_i].visible=v;});}}
var _d={};$.each(upd,function(i,e){_d[i]=self.data[i].values;});self.updateSearchData(_d,true);};self.toHotelList=function(id,remove){if(id){var $el=$(self.data.HOTELS.values[id].el);var $inp=$el.find('input');if($inp.is(':checked')&&!remove){if($('#HOTELS_samo_element_clone_'+id).size()){return false;}
var $_el=$el.clone().removeAttr('id').attr('id','HOTELS_samo_element_clone_'+id).css('display','block');$inp=$_el.find('input').removeClass('samo_hotel_item').addClass('samo_hotel_item_clone');$('#HOTELS_LIST').append($_el);}else{$('#HOTELS_samo_element_clone_'+id).remove();if(remove){$inp.removeAttr('checked');self.data.HOTELS.values[id].selected=false;}}}else{$('#HOTELS_LIST label').remove();$('#HOTELS input:checked').removeAttr('checked');$.each(self.data.HOTELS.values,function(i,e){self.data.HOTELS.values[i].selected=false;});}
var hl=$('#HOTELS_LIST').height();var count=$('#HOTELS_LIST label').size();if(count>=self.getSetting('QUICKHOTELLISTLIMIT')){$('#HOTELS_LIST').css({height:hl,overflowY:'auto'});}else{$('#HOTELS_LIST').css({height:'auto',overflowY:'auto'});hl=$('#HOTELS_LIST').height();}
if(count){$('#HOTELS_LIST').show();$('#HOTELS').height();var _h=$('#HOTELS_LIST').outerHeight();$('#HOTELS').css({top:_h,height:self.hotelsDivDefHeight-_h});}else{$('#HOTELS_LIST').hide();$('#HOTELS').css({top:0,height:self.hotelsDivDefHeight});}
self.checkAny();};self.dateTo112=function(d){if(d){var res=d.split('.');if(res.length==3){return res[2]+res[1]+res[0];}}
return d;};self.showAdvanced=function(){self.showHide('adv',true);$('#SHOW_ADV').remove();};self.cancelEvent=function(e){if(typeof e.cancelBubble!='undefined'){e.cancelBubble=true;}
if(typeof e.stopPropagation!='undefined'){e.stopPropagation();}};self.changeStateInc=function(){self.resetSearchParams();self.doRequest('stateinc',self.getSearchParams(true,null,null,null,self.getPredefinedParams()));};self.construct=function(){self.data={};self.inited=false;self._settings={};self.lastSearchParams={};self.hidePreloader=false;self.hotelsSets=false;self.nextId=false;self.tab='TOUR';self.currentOperator=false;self.lastOperators=[];self.hiddenClicked=false;self.HOTEL_INFO={};self.OPERATOR_SUPPORT={};self.INSTALLMENTS={};self.httpCache={};self.httpCacheTTL=CACHE_TTL;self.getParams={};var url=window.location.href.split('/');url=url[url.length-1];url=url.substring(url.indexOf('?')+1);url=url.replace(/#.*?$/,'');url=url.split('&');$.each(url,function(i,e){e=e.split('=');if(e.length==2){self.getParams[e[0]]=e[1].replace(/%2C/g,',');}});if(typeof self.getParams.FREIGHT!='undefined'){if(parseInt(self.getParams.FREIGHT)){$('#FREIGHT').attr('checked','checked');}else{$('#FREIGHT').removeAttr('checked');}}
if(typeof self.getParams.STOPSALE!='undefined'){if(parseInt(self.getParams.STOPSALE)){$('#STOPSALE').attr('checked','checked');}else{$('#STOPSALE').removeAttr('checked');}}
self.$container=$('#SAMO_SEARCH');self.agent=self.$container.data('samo-uid');self.async_mode=self.$container.data('samo-async');self.searchTimer=false;self.miniMode=self.$container.data('samo-mini');if(!self.miniMode){if(document.cookie.match(/samo_search_result=short;/)){self.resultsShortView=true;}else if(document.cookie.match(/samo_search_result=full;/)){self.resultsShortView=false;}else{self.resultsShortView=self.getSetting('RESULTSSHORTVIEW');}
self.hotelsDivDefHeight=parseInt($('#HOTELS').height());if(!self.hotelsDivDefHeight){self.hotelsDivDefHeight=305;}
if(self.resultsShortView){$('#SEARCH_RESULTS_CONTAINER').removeClass('samo_width');}}
if(!self.miniMode){var spt=self.getSetting('SHOWPACKETTYPE');self.showHide('packettype',spt);var pt=self.getSetting('PACKETTYPE');if(pt===null){pt=0;}
samo.settings.search.PACKETTYPE=pt;$('#PACKETTYPE input[value='+pt+']').attr('checked','checked');}
$.each(['TOWNFROMINC','STATEINC','ADULT','CHILD','NIGHTS_FROM','NIGHTS_TILL','STARS','HOTELS','MEAL','CHECKIN_BEG','CHECKIN_END','TOWNTO','OPERATORS','AGES','TOUR','COSTMIN','COSTMAX','CURRENCYINC','PACKETTYPE','STOPSALE','FREIGHT','DAYS_OFFSET','LANGUAGE','CATEGORY','GEOPOINT'],function(i,e){var any=false;var def=self.getParams[e];if(self.miniMode){if(e=='TOWNTO'||e=='HOTELS'||e=='TOUR'){any='Любой';}else if(e=='STARS'){any='Любая';}else if(e=='MEAL'){any='Любое';}}else{if(e=='OPERATORS'||e=='TOUR'){any='Любой';}}
self.data[e]={_default:typeof def!='undefined'?def:self.getSetting(e),values:[],any:any};});Date.dayNames=['Воскресенье','Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];Date.abbrDayNames=['Вс','Пн','Вт','Ср','Чт','Пт','Сб'];Date.monthNames=['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];Date.abbrMonthNames=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];$('input.date',self.$container).datePicker().mask('39.19.2099');self.addPreloader();$('#TOWNFROMINC').on('change',function(){self.resetSearchParams();self.doRequest('townfrominc',self.getSearchParams(true,null,null,null,self.getPredefinedParams()));});$('#STATEINC').on('change',function(){self.changeStateInc();});$('#OPERATORS').on('change',function(){self.loadOperatorsData=true;});$('#LOAD').on('click',function(){if(self.miniMode){var params=self.getSearchParamsForPrice();params.DOLOAD=1;params=self.clearParams(params);var url=samo.search_datasearchurl;if(params.STATEINC){var gts=self.getSetting('GOTOSTATE_'+params.STATEINC);if(gts){url=gts;}}
self.redirect(url+$.param(params));return;}
self.closeNotify();self.doRequest('prices',self.getSearchParamsForPrice());});self.setTab=function($elem){if(self.miniMode)return;if(typeof $elem=='string'){$elem=$('#SAMO_TAB_'+$elem);}
if(!$elem.size()){$elem=self.$container.find('.samo_tab:first');}
var tabName=$elem.attr('id').toString().replace(/SAMO_TAB_/g,'');self.tab=tabName;if(!$elem.is('.samo_tab_active')){self.resetSearchParams();var t=self.inited?TAB_CHANGE_SPEED:0;var showFunc=function(){self.$container.find('.samo_tab_wanderer').each(function(i,e){i=e.id;var $p=$('#SAMO_TAB_PARENT_'+tabName+'_'+i);if($p.size()){$p.html();$p.append($('#'+i));}});$('#SAMO_TAB_CONTAINER_'+tabName).fadeIn(t,function(){$(this).removeClass('samo_tab_container_hidden').addClass('samo_tab_container_active');});self.$container.find('.samo_tab').removeClass('samo_tab_active');$('#SAMO_TAB_'+tabName).addClass('samo_tab_active');if(self.inited){self.doRequest('init',self.getSearchParams(true,null,null,null,self.getPredefinedParams()));}};if(self.$container.find('.samo_tab_container_active').size()){self.$container.find('.samo_tab_container_active').removeClass('samo_tab_container_active').fadeOut(t,showFunc);}else{showFunc();}
self.clearSearchResults();}};$toTopDiv=$('#SAMO_TOTOP_BTN');if(self.getSetting('SHOWGOTOTOPBTN')){$toTopDiv.show();$toTopDiv.on('click',function(){self.$container.scrollTo(SCROLL_TO_TOP_TIME);});$(window).on('resize scroll',function(){$toTopDiv.css({left:$(document).width()-$toTopDiv.outerWidth(true)});var perc=0;if($('#SEARCH_RESULTS:visible').size()){var dt=self.$container.offset().top;var h=$(document).height()-dt;var scroll=$(document).scrollTop()-dt;if(scroll>0){perc=scroll/h*20;if(perc>1){perc=1;}}}
$toTopDiv.css('opacity',perc);if(!perc){$toTopDiv.hide();}else{$toTopDiv.show();}});}else{$toTopDiv.remove();}
self.resetPacketType=function(val){if(val!==null){$('#PACKETTYPE input[value='+val+']').attr('checked','checked');}
var f=$('#PACKETTYPE input[type=radio]:checked').val()==0;self.showHide('freight',f);if(!f){$('#FREIGHT').removeAttr('checked');}else{$('#FREIGHT').attr('checked','checked');}};self.getSearchParamsForPrice=function(page){params=self.getSearchParams(false,page);params.preview_width=HOTEL_PREVIEW_WIDTH;params.preview_height=HOTEL_PREVIEW_HEIGHT;self.lastSearchParams=params;return params;};self.changeOperators=function(){self.loadOperatorsData=false;var o=self.getSearchParams(false,false,'OPERATORS');var noGetOperator=false;if(o){o=o.split(',');if(o.length>1){noGetOperator=true;}}
self.resetSearchParams();self.doRequest('operator',self.getSearchParams(false,false,false,noGetOperator));};self.checkCheckin=function(selectedDates){var _cb=$('#CHECKIN_BEG').val(),ce=self.dateTo112($('#CHECKIN_END').val());var cb=self.dateTo112(_cb);if(ce<cb){$('#CHECKIN_END').val($('#CHECKIN_BEG').val());}
$('#CHECKIN_BEG').dpSetSelected(_cb).val(_cb);var _ce=$('#CHECKIN_END').val();$('#CHECKIN_END').dpSetSelected(_ce).val(_ce);};if(!self.miniMode){$('#INSTRUCTION').on('click',function(){self.doRequest('instruction',self.getSearchParams());});self.$container.delegate('.samo_tab','click',function(){self.setTab($(this));});self.$container.delegate('.price_next_container_close','click',function(){var key='__next_price_'+$(this).data('samo-next-id');self[key][0].remove();self[key][1].remove();self[key]=false;});self.$container.delegate('.samo_next','click',function(){if(self.getParams.DOLOAD==1){params=self.getSearchParamsForPrice($(this).data('samo-page'));self.getParams.DOLOAD=0;}else{params=self.lastSearchParams;params.PAGE=$(this).data('samo-page');}
self.closeNotify();self.doRequest('prices',params);});self.$container.delegate('#PACKETTYPE input[type=radio]','click',function(){self.resetPacketType();});self.$container.delegate('.samo_results_full, .samo_results_short','click',function(){var _short=$(this).is('.samo_results_short');self.setCookie('samo_search_result',_short?'short':'full');self.resultsShortView=_short;self.showHide('full_result',!_short);self.showHide('short_result',_short);if(_short){$('#SEARCH_RESULTS_CONTAINER').removeClass('samo_width');$('#SEARCH_RESULTS .samo_results_short').addClass('result_button_selected');$('#SEARCH_RESULTS .samo_results_full').removeClass('result_button_selected');}else{$('#SEARCH_RESULTS_CONTAINER').addClass('samo_width');$('#SEARCH_RESULTS .samo_results_short').removeClass('result_button_selected');$('#SEARCH_RESULTS .samo_results_full').addClass('result_button_selected');self.updateBlockers();}});self.$container.delegate('#HOTELS input','click',function(){self.data.HOTELS.values[$(this).val()].selected=$(this).is(':checked');});self.$container.delegate('.samo_price_next','click',function(){self.nextId=$(this).data('samo-next-id');self.doRequest('price_next',{nextId:self.nextId,currency:$('#CURRENCYINC').val()});});self.$container.delegate('#GOTOTOP','click',function(){self.$container.scrollTo(SCROLL_TO_TOP_TIME);});self.$container.delegate('.samo_hidden_options_close','click',function(){self.hideHiddenOptions();});$.each(['STARS','MEAL','OPERATORS'],function(i,e){self.$container.delegate('#show_'+e+'_hidden_options','click',function(){self.showHiddenOptions(e);});});self.$container.delegate('#HOTELS input','click',function(){self.toHotelList($(this).val());});self.$container.delegate('.samo_hotel_item_clone','click',function(){self.toHotelList($(this).val(),true);});$(document).bind('click',function(){if(!self.hiddenClicked){self.hideHiddenOptions();}
self.hiddenClicked=false;});self.$container.delegate('.samo_hidden_options *, .samo_hidden_options','click',function(e){self.hiddenClicked=true;self.calcHiddenOptions();self.drawSamoCheckBoxes();});$('#SHOW_ADV').on('click',function(){self.showAdvanced();});}else{$('#SHOW_TOWNTO').on('click',function(){$('#TOWNTO_CONTAINER').show();$(this).remove();});}
$('#CHECKIN_BEG, #CHECKIN_END').on('change dpClosed',function(){self.checkCheckin();});$(document).delegate('.samo_checkbox_mini_container label','click',function(e){self.drawSamoCheckBoxes($(e.target));});$('#CHILD').on('change',function(){self.resetChilds();});self.resetChilds=function(data){if(data){self.data.AGES.values=data;}
var i=parseInt($('#CHILD').val());if(i){$('.samo_child_age:lt('+(i)+')',self.$container).show();$('.samo_child_age:gt('+(i-1)+')',self.$container).hide();$('.samo_child_age_title',self.$container).show();if((!self.inited&&self.data.AGES._default)||self.data.AGES.values.length){var arr=self.data.AGES.values.length?self.data.AGES.values:self.data.AGES._default.split(',');$.each(arr,function(i,e){$('.samo_child_age:eq('+(i)+')',self.$container).val(e);});}}else{$('.samo_child_age',self.$container).hide();$('.samo_child_age_title',self.$container).hide();}};$('#NIGHTS_FROM, #NIGHTS_TILL').on('change',function(){var nf=parseInt($('#NIGHTS_FROM').val());var nt=parseInt($('#NIGHTS_TILL').val());if(nt<nf){if($(this).is('#NIGHTS_FROM')){$('#NIGHTS_TILL').val(nf);}else{$('#NIGHTS_FROM').val(nt);}}});if(!self.miniMode){self.$container.delegate('#TOWNTO input, #STARS input','change',function(e){self.checkAny();self.setFilter(e);});self.$container.delegate('#MEAL input, #OPERATORS input','change',function(e){self.checkAny();});self.checkAny=function(){if(self.miniMode)return;$.each(['TOWNTO','STARS','MEAL','HOTELS_LIST','OPERATORS'],function(i,e){if($('#'+e+' input:checked').size()){$('#'+e+'_ANY').removeAttr('checked');}else{$('#'+e+'_ANY').attr('checked','checked');}});self.calcHiddenOptions();self.drawSamoCheckBoxes();};$('#TOWNTO_ANY, #STARS_ANY, #MEAL_ANY, #HOTELS_LIST_ANY, #OPERATORS_ANY').on('change',function(){var name=this.id.replace(/_ANY/,'');$('#'+name+' input').removeAttr('checked');if(!$(this).is(':checked')){$(this).attr('checked','checked');}
if(name=='TOWNTO'||name=='STARS'||name=='MEAL'||name=='OPERATORS'){if(name!='MEAL'&&name!='OPERATORS'){self.setFilter();}
if(name=='OPERATORS'){self.changeOperators();}
self.calcHiddenOptions();self.drawSamoCheckBoxes();}else if(name=='HOTELS_LIST'){self.toHotelList();}});self.$container.delegate('#STARS label, #MEAL label','mouseenter',function(){$(this).unbind('mouseenter');if($(this).is('.samo_tooltip_applied'))return;var alias=$(this).attr('title');if(!alias)return;if(alias!=$(this).text()){$(this).removeAttr('title');$(this).setToolTip(alias,1,TOOLTIP_OVER_TIMEOUT_SHORT).setHideTimeout(HIDDEN_OPTIONS_TOOLTIP_TIMEOUT).show();}});self.$container.delegate('.samo_hotel_info','mouseenter',function(){$(this).unbind('mouseenter');if($(this).is('.samo_tooltip_applied'))return;var k=$(this).data('samo-hotelinfo-key');if(self.HOTEL_INFO[k]){var pi=$(this).data('samo-preview-image');self.HOTEL_INFO[k].previewImage=pi;var h=self.HOTEL_INFO[k].description[0]._;if(h.length>MAX_HOTEL_INFO_DESCRIPTION_LEN){h=h.substring(0,MAX_HOTEL_INFO_DESCRIPTION_LEN);var dotPos=h.lastIndexOf('.');if(dotPos>-1){h=h.substring(0,dotPos+1);}else{h=$.trim(h);h+='&hellip;';}
self.HOTEL_INFO[k].description[0]._=h;}
var $r=$('#HOTEL_INFO_TMPL').tmpl(self.HOTEL_INFO[k]);if($.trim($r.text())){$(this).setToolTip($r,self.resultsShortView?1:0,TOOLTIP_OVER_TIMEOUT).show();}}});self.$container.delegate('.samo_installment','mouseenter',function(){$(this).unbind('mouseenter');if($(this).is('.samo_tooltip_applied'))return;var k=$(this).data('samo-installment-id');if(self.INSTALLMENTS[k]){var i=self.INSTALLMENTS[k];if(i.Hint){$(this).setToolTip('<span class="samo_installment_hint">'+i.Hint+'</span>',0,TOOLTIP_OVER_TIMEOUT_SHORT).show();}
if(i.Url){$(this).addClass('samo_installment_link');$(this).on('click',function(){self.redirect(i.Url);});}}});self.$container.delegate('.samo_show_tooltip','mouseenter',function(){$(this).unbind('mouseenter');if($(this).is('.samo_tooltip_applied'))return;var hint=$(this).data('samo-hint');if(hint){$(this).setToolTip(hint,0,TOOLTIP_OVER_TIMEOUT_SHORT).show();}});self.$container.delegate('.samo_operator','mouseenter',function(){$(this).unbind('mouseenter');if($(this).is('.samo_tooltip_applied'))return;var k=$(this).data('samo-operator');if(self.OPERATOR_SUPPORT[k]){var $r=$('#OPERATOR_SUPPORT_TMPL').tmpl(self.OPERATOR_SUPPORT[k]);if($r.text()){$(this).setToolTip('<span class="samo_support_tooltip">'+$r.html()+'</span>',0,TOOLTIP_OVER_TIMEOUT_SHORT).show();}}});self.$container.delegate('#HOTELS_FILTER','keyup change',function(e){clearTimeout(self.searchTimer);self.searchTimer=setTimeout(function(){self.setFilter(e);},TEXT_FILTER_TIMEOUT);});self.$container.delegate('.operator_redirect','click',function(){self.redirect(samo.search_datasource+$.param({action:'operator_redirect',claiminc:$(this).attr('data-samo-price-id')}));});var $terms=$('#TERMS_TMPL').tmpl();if($.trim($terms.text())!=''){self.terms=new samo.popup($terms.html());$('#TERMS').on('click',function(){self.terms.show();});self.showHide('terms',true);}else{self.showHide('terms',false);}
self.showHide('operator_select',self.getSetting('SHOWOPERATORSELECT'));self.showHide('filter',self.getSetting('SHOWFILTER'));}else{self.$container.delegate('#TOWNTO, #STARS','change',function(e){self.setFilter(e);});}
var params={};if(self.getParams.DOLOAD==1){params=self.getSearchParamsForPrice(self.getParams.PAGE?self.getParams.PAGE:null);params.DOLOAD=1;}else{params=self.getSearchParams(true,null,null,null,self.getPredefinedParams());}
self.tab=self.getParams.TAB;if(!self.tab){self.tab='TOUR';}
self.setTab(self.tab);self.doRequest('init',params);};self.getPredefinedParams=function(){return typeof SAMO_SEARCH_PREDEFINED_PARAMS_UPDATE_FUNC!=='undefined'?SAMO_SEARCH_PREDEFINED_PARAMS_UPDATE_FUNC():false;};self.showHide=function(name,show){var el=$('.show_hide_'+name,self.$container);if(!show){el.hide();}else{el.show();}};self.addPreloader=function(){$('body').append('<div id="preloader"><div class="blocker"></div><div class="runner">'+'<div id="SAMO_LOADING_PROGRESS"><div class="samo_progress_bar"><div class="samo_progress_percent"></div><div class="samo_progress_percent_text"></div></div></div>'+'<div class="samo_std_loader"><div class="div1"></div><div class="div2"></div></div></div></div>');$(document).ajaxStart(function(){if(!self.hidePreloader){self.preloaderShow();}}).ajaxStop(function(){self.preloaderHide();self.hidePreloader=false;});};self.getSearchParams=function(removeOperator,page,name,noGetOperator,predefinedParams){var params={};var tmp='';var arr;if(name){arr={};arr[name]=0;}else{arr=self.data;}
$.each(arr,function(i,e){if(i=='AGES'){var ages=[];$('.samo_child_age:visible',self.$container).each(function(i,e){ages.push($(e).val());});if(ages.length){params[i]=ages.join(',');}}else if(i=='PACKETTYPE'){params[i]=self.inited&&$('#PACKETTYPE input[name=PACKETTYPE]:checked').size()?$('#PACKETTYPE input[name=PACKETTYPE]:checked').val():e._default;}else if(i=='FREIGHT'||i=='STOPSALE'){params[i]=$('#'+i).size()?($('#'+i).is(':checked')?1:0):1;}else if(i=='LANGUAGE'||i=='CATEGORY'||i=='GEOPOINT'){var $el=$('#'+i);var val=$el.val();if(val){if(i=='GEOPOINT'){var tmp=[];for(var ind in val){if($el.find('option[data-samo-added][value="'+val[ind]+'"]').size()){params['SEARCHTEXT']=val[ind];}else{tmp.push(val[ind]);}}
val=tmp;}
params[i]=val.join(',');}}else{if(!self.miniMode&&self.inited&&(i=='TOWNTO'||i=='HOTELS'||i=='MEAL'||i=='STARS'||i=='OPERATORS')){if(noGetOperator&&i=='OPERATORS'){params[i]='';}else{var p=[];if(i=='HOTELS'){$.each(self.data.HOTELS.values,function(i,e){if(e.selected){p.push(e.id);}});}else{$('#'+i+' input:checked').each(function(i,e){p.push($(e).val());});}
if(p.length){params[i]=p.join(',');}}}else{params[i]=self.inited&&$('#'+i).size()?$('#'+i).val():e._default;if((i=='CHECKIN_BEG'||i=='CHECKIN_END')){params[i]=self.dateTo112(params[i]);}}}});if(removeOperator){params.OPERATORS=null;}
if(predefinedParams){$.each(predefinedParams,function(i,e){params[i]=e;});}
params.PAGE=page?page:1;return name?params[name]:params;};self.setCookie=function(name,val){var d=new Date();d.setTime(d.getTime()+3600000*24*365);document.cookie=name+'='+val+';path=/;expires='+d.toGMTString();};self.pricesProgressRun=function(data){if(data.ADV_PARAMS!=null){var progress=data.ADV_PARAMS.progress;params={};params.action='prices_async_progress';params.key=data.ADV_PARAMS.md5_search_params;$('#prices_progress_val').html(progress);var step=0;self.pricesProgressUpdateIfNeed(progress,step);}};self.pricesProgressUpdateIfNeed=function(progress,step){setTimeout(function(){$.jsonLoad(params,null,function(data){$('#prices_progress_val').html(progress);if(progress>0&&progress<100){self.pricesProgressUpdateIfNeed(data.progress,step+1);}
if(progress==100&&step>0){$('#prices_progress_reload').show();$('#prices_progress_reload').on('click',function(){params=self.lastSearchParams;params.PAGE=$(this).data('samo-page');self.closeNotify();self.doRequest('prices',params);$('.prices_progress').hide();});}})},2000);};if(!document.all){$(window).on('beforeunload',function(){self.error=function(){return false};});}
var c=document.cookie.match(/samo_TOWNFROMINC=([0-9]+)/);if(c){samo.settings.search.TOWNFROMINC=c[1];}
c=document.cookie.match(/samo_STATEINC=([0-9]+)/);if(c){samo.settings.search.STATEINC=c[1];}
$('#TOWNFROMINC, #STATEINC').on('change',function(){self.setCookie('samo_'+this.id,this.value);});self.construct();return self;};$(document).ready(function(){samo.view=new samo.search();});})(samo.jQuery);