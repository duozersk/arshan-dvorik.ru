if(typeof samo==='undefined'){var samo={version:'1.01',datasource:'?'};}
samo.jQuery=jQuery.noConflict(true);(function($){samo.datasource=$('#SAMO_RESERV').data('samo-datasource');$.ajaxSetup({error:function(xhr,status,e){$.event.trigger('ajaxStop');var error='';if('timeout'==status){error='Timeout error, try again later...';}else{error='Ajax error: '+status;}
if(samo.view){samo.view.error(error);}else{alert(error);}},timeout:60000,scriptCharset:'utf-8',dataType:'jsonp',type:'POST'});$.ajaxPrefilter("jsonp",function(options){options.global=true;});$.jsonLoad=function($get_params,$params,$callback,$error){$params=$params||{};$callback=$callback||function(){};$get_params.version=samo.version;$.ajax({url:samo.datasource+$.param($get_params),data:$params,success:$callback});};samo.reserv=function(){var self={};self.construct=function(){self.claimInc=null;self.authMode=$('#SAMO_RESERV').data('samo-auth');self.lastAction=null;self.lang=samo.settings.lang;$('body').append('<div id="preloader"><div class="blocker"></div><div class="runner"><div class="div1"></div><div class="div2"></div></div></div>');$(document).ajaxStart(function(){$('#preloader').css('display','block');}).ajaxStop(function(){$('#preloader').css('display','none');});self.getParams={};var url=window.location.href.split('/');url=url[url.length-1];url=url.substring(url.indexOf('?')+1);url=url.split('&');$.each(url,function(i,e){e=e.split('=');self.getParams[e[0]]=e[1];});self.authKey=self.getParams.key;self.view=new Model(self.authKey,self);self.authEmail=self.getParams.email;self.agent=$('#SAMO_RESERV').data('samo-agent');if(!self.authMode){self.login();}else{self.inited=true;$('#samo_auth_email').val(self.getEmailFromCookie());}};self.closePopup=function(){$.each(['payWindow','instructionWindow','listWindow','docWindow'],function(i,e){if(self[e]){self[e].hide();}});};self.showDocument=function(doc){self.doRequest('tourist_document_url',{DOCUMENTID:doc.id()});};self.forgotPassword=function(){var email=prompt(self.msg('enterEmail'),$('#samo_auth_email').val());if(email){self.doRequest('forgot_buyer_psw',{email:email});}};self.redirect=function(url,selfWindow){if(selfWindow){window.location.href=url;}else{window.open(url);}};self.login=function(){var action='';var params='';if(self.authMode){var email=$.trim($('#samo_auth_email').val());var psw=$.trim($('#samo_auth_psw').val());if(email==''||psw==''){self.error(self.msg('enterEmailAndPassword'));if(email==''){$('#samo_auth_email').focus();}else{$('#samo_auth_psw').focus();}
return;}
action='tourist_auth';var nonce=String(Math.round(Math.random()*0xFFFFFF)).md5();psw=String(psw.md5()+nonce).md5();params={EMAIL:email,NONCE:nonce,PSW:psw};}else{action=self.authKey?'tourist_auth':'tourist_info';params=self.authKey?{KEY:self.authKey,EMAIL:self.authEmail}:null;}
self.doRequest(action,params);return false;};self.loadList=function(){if(!self.list){self.doRequest('tourist_full_claim_list');}else{self._callback_tourist_full_claim_list(self.list);}};self.loadClaim=function(data){var inc=data?data.inc():false;self.closePopup();if(self.claimInc!=inc){self.doRequest('tourist_info',inc?{CLAIM:inc}:null);}};self.msg=function(key){if(samo.settings.lang.messages[key]){return samo.settings.lang.messages[key];}
return key;};self.callback=function(data){var error=false,errorFromClaim=false;if(!data.error&&data.claim&&data.claim.error){data.error=data.claim.error;data.code=data.claim.code;errorFromClaim=true;}
if(data.error){if(data.code==3){self.error(data.error);if(!self.authMode){self.logout(data.error);}
return false;}
if(self.inited){self.error(data.error);}else{if(!errorFromClaim){self.globalError(data.error);}}
if(!errorFromClaim){return false;}}
if(data.message){self.message(data.message);}
var func='_callback_'+self.lastAction;if(self[func]){self[func](data);}};self._callback_tourist_auth=function(data){if(self.authMode){self.putEmailToCookie($('#samo_auth_email').val());self.redirect(samo.settings.reserv?samo.settings.reserv.LOGIN_URL:samo.settings.tourist_claim.LOGIN_URL,true);}else{self.view.turnOff();if(!data.claim){data.claim={'error':self.msg('claimsNotFound')};}
self.view.setData(data);self.inited=self.view.initialized;if(data&&data.claim_inc){self.claimInc=data.claim_inc;}
if(self.authEmail){self.putEmailToCookie(self.authEmail);}}};self._callback_tourist_info=function(data){self._callback_tourist_auth(data);};self._callback_tourist_confirm_claim=function(data){self._callback_tourist_auth(data);};self._callback_tourist_instruction=function(data){self.instructionWindow=new samo.popup(data.text).show();};self._callback_tourist_logout=function(data){self.redirect(samo.settings.reserv?samo.settings.reserv.LOGOUT_URL:samo.settings.tourist_claim.LOGOUT_URL,true);};self._callback_tourist_pay=function(data){self.view.setData({pays:data});};self._callback_tourist_full_claim_list=function(data){self.list=data;self.view.setData({list:data});self.listWindow=new samo.popup($('#samo_list')).show();};self._callback_tourist_documents=function(data){if(data.documents&&data.documents[0]){self.view.setData({docs:data.documents});self.docWindow=new samo.popup($('#samo_doc_list')).show();}else{self.error(self.msg('documentsNotFound'));}};self._callback_tourist_document_url=function(data){if(data.url){self.redirect(data.url);self.closePopup();}else{self.error(self.msg('documentURLNotFound'));}};self._callback_forgot_buyer_psw=function(data){if(data.email){self.error(self.msg('newPasswordWasSent')+data.email);}else{self.message(self.msg('unknownError'));}};self.putEmailToCookie=function(email){document.cookie='samo_reserv_email='+email;};self.getEmailFromCookie=function(){var email=document.cookie.match(/samo_reserv_email=.*?;/g);if(email&&email.length){email=email[0].split('=');if(email.length==2){email=email[1];email=email.replace(/;/g,'');return email;}}
return'';};self.loadPayVariants=function(){if(self.view.paysLoaded()){self.view.paysLoaded(false);}else{self.doRequest('tourist_pay');}};self.confirmClaim=function(){var code=$.trim($('#SAMO_RESERV .confirm_code_container input:first').val());if(!code){self.error('Введите код подтверждения');}else{self.doRequest('tourist_confirm_claim',{ccode:code});}};self.loadDocList=function(){self.doRequest('tourist_documents');};self.instruction=function(item,event){if(!self.instructionWindow){self.doRequest('tourist_instruction');}else{self.instructionWindow.show();}};self.doRequest=function(action,params){params=params?params:{};params.AGENT=params.uid=self.agent;if(!params.action){params.action=action;}
if(!params.CLAIM){params.CLAIM=self.claimInc;}
if(self.getParams.pay){params.pay=getParams.pay;}
$.each(params,function(i,e){if(!e){delete params[i];}});self.lastAction=action;$.jsonLoad(params,null,self.callback);};self.globalError=function(msg){self.view.globalError(msg);};self.error=function(msg){alert(msg);};self.message=function(msg){alert(msg);};self.log=function(data){if(console&&console.log){console.log(data);}};self.logout=function(msg){var quick=!self.authKey;msg=typeof msg=='string'?msg:false;msg=msg?msg:self.msg('logoutProcess');if(!quick){self.globalError(msg);}else{self.view.turnOff();}
if(!self.authKey){setTimeout(function(){self.doRequest('tourist_logout');},quick?0:500);}};self.construct();};var Model=function(authKey,_parent){var self=this;self.parent=_parent;self.checkClaim=function(data){var error=false;if(!data){error={error:self.parent.msg('unknownError')};}else{if(data.claim&&data.claim.error){error=data.claim;}}
if(error){self.parent.error(error.error);}
return error;};self._mapping={buyer:{key:function(data){return 1;}},list:{key:function(data){return ko.utils.unwrapObservable(data.inc);}},docs:{key:function(data){return ko.utils.unwrapObservable(data.id);}},pays:{key:function(data){return ko.utils.unwrapObservable(data.id);}}};self.today=function(){var d=new Date();var res='';switch(d.getDay()){case 0:res='Воскресенье';break;case 1:res='Понедельник';break;case 2:res='Втроник';break;case 3:res='Среда';break;case 4:res='Четверг';break;case 5:res='Пятница';break;case 6:res='Суббота';break;}
res+=', '+d.getDate()+' ';switch(d.getMonth()){case 0:res+='января';break;case 1:res+='февраля';break;case 2:res+='марта';break;case 3:res+='апреля';break;case 4:res+='мая';break;case 5:res+='июня';break;case 6:res+='июля';break;case 7:res+='августа';break;case 8:res+='сентября';break;case 9:res+='октября';break;case 10:res+='ноября';break;case 11:res+='декабря';break;}
res+=' '+d.getFullYear()+'г.';return res;};self.showPayForm=function(pay,e){if(e.target.tagName=='A'){return true;}else{form=pay.form?pay.form():false;if(form){var $d=$('<div></div>').append(form);var $f=$d.find('form');$f.attr('target','_blank').find('.close_pay_form').remove();$f.addClass('samo_pay_form');$f.bind('submit',function(){self.parent.closePopup();});self.parent.payWindow=samo.popup($d).show();}else if(pay.url){self.parent.redirect(pay.url());}}};self.construct=function(){self.data={};self.initialized=ko.observable(false);self.globalErrorOccurred=ko.observable(false);self.claimLoaded=ko.observable(false);self.showPayVariants=ko.observable(false);self.showConfirmCode=ko.observable(false);self.listLoaded=ko.observable(false);self.paysLoaded=ko.observable(false);self.docsLoaded=ko.observable(false);self.noAuthByKey=ko.observable(authKey?false:true);ko.applyBindings(self);};self.setData=function(data){self.data={};var error=false;if(data){error=data.error?data.error:(data.claim?self.checkClaim(data):false);if(!error){if(data.claim){self.turnOff();self.showPayVariants(false);self.showConfirmCode(false);if(data.claim.claimDocument[0].buyerMoneys){data.claim.claimDocument[0].buyerMoneys[0].buyerClaimMoney[0]._paid=parseInt(data.claim.paid[0]._);data.claim.claimDocument[0].buyerMoneys[0].buyerClaimMoney[0]._paidCurrency=data.claim.paidCurrency[0]._;}
if(data.claim.variants&&data.claim.variants[0]===null){data.claim.variants=[];}
var _status=data.claim.claimDocument[0].status;var _condition=data.claim.claimDocument[0].condition;var _payStatus=data.claim.claimDocument[0].payStatus;var st='';if(_condition=='ccOffer'){st='offer';}else{if(_status=='csNotActivated'||_status=='csNotReaded'||_status=='csProcessed'){st='accepted';}else if(_status=='csUnconfirmed'||_status=='csCancelled'||_status=='csAwaitingCancel'){st='cancelled';}else if(_status=='csConfirmed'){st='confirmed';}}
if(st=='confirmed'&&_payStatus=='psPaid'){st='paid';}
data.claim.claimDocument[0].mainInfoStatus=st;if(data.claim.showPayVariants){self.showPayVariants(true);}
if(data.needTouristConfirmation){self.showConfirmCode(true);setTimeout(function(){$('#SAMO_RESERV .confirm_code_container input:first').focus();},100);}}}
$.each(['claim','buyer','list','pays','docs','help'],function(i,e){if(data[e]){self.data[e]=data[e];}});if(!data.claim){delete self.data.claim;}}
if(error){self.data.error=typeof error=='string'?{error:error}:error;}
ko.mapping.fromJS(self.data,self._mapping,self);$.each(['claim','list','pays','docs'],function(i,e){if(data[e]){self[e+'Loaded'](error?false:true);if(e=='claim'){self.initialized(true);}}});};self.dateFormat=function(val,time,noYear){if(!val)return'-';val=val.split('-');if(time){time=val[2].split(' ');if(time.length==1){time=time[0].split('T');}
if(time.length==2){time=time[1].split(':');}else{time=false;}}
if(time){noYear=true;}
val=val[2].substring(0,2)+'.'+val[1]+'.'+val[0]+(!noYear?'г':'')+(time?(' '+time[0]+':'+time[1]):'');return val;};self.globalError=function(msg){self.turnOff();self.setData({error:{error:msg}});self.globalErrorOccurred(false);self.globalErrorOccurred(true);};self.turnOff=function(){self.data={};self.initialized(false);self.claimLoaded(false);self.docsLoaded(false);self.paysLoaded(false);self.listLoaded(false);self.parent.getParams.pay=0;};self.lang=function(type,value){if(self.parent.lang&&self.parent.lang[type][value]){value=self.parent.lang[type][value];}
return value;};self.construct();};$(document).ready(function(){samo.reserv();});})(samo.jQuery);