var samo={el:{},preloader:null,httpcache:{},cachelifetime:900000,settings:{},_settings:{},next_price_tr:null,instruction:null,last_ev:null,operator_help_loading:false,over_operator:false};function error_msg(msg,showInResultset){window.status=msg;document.title=msg;if(showInResultset){$('#resultset').html('<span class="bold red">'+msg+'</span>');}}
$.jsonLoad=function($get_params,$callback){$get_params.uid=samo.uid;if($get_params.action=='stateinc'||$get_params.action=='townfrominc'){$get_params.OPERATORS=0;}
var url=samo.datasource+$.param($get_params);var now=+(new Date());var callback=function(result){if(result.error){error_msg(result.error);}else{samo.httpcache[url]={json:result,datetime:now};$callback(result);}}
if(typeof samo.httpcache[url]!=='undefined'&&samo.httpcache[url].datetime+samo.cachelifetime>now){$callback(samo.httpcache[url].json);}else{$.ajax({url:url,success:callback,dataType:'jsonp'});}}
Date.dayNames=['Воскресенье','Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];Date.abbrDayNames=['Вс','Пн','Вт','Ср','Чт','Пт','Сб'];Date.monthNames=['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];Date.abbrMonthNames=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];$(document).ready(function(){if(typeof $.ajaxPrefilter=='function'){$.ajaxPrefilter(function(options){options.global=true;});}
$('body').append('<div id="preloader">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Загрузка данных&hellip;</div>');$('#preloader').bind('ajaxStart',function(){if(!samo.operator_help_loading){$(this).css('display','block');}}).bind('ajaxStop',function(){$(this).css('display','none');});$.ajaxSetup({error:function(xhr,status,e){if('timeout'==status){error_msg('Timeout error, try again later...');}},timeout:60000,scriptCharset:'utf-8',dataType:'jsonp'});(function(){var $search=$('#search_tour');samo.result_tpl=$('#result-template').html();samo.notfound_tpl=$('#notfound-template').html();samo.uid=$search.attr('samo:uid');samo.datasource=$search.attr('samo:datasrc');samo.bronurl=$search.attr('samo:datatrg');$.event.trigger('ajaxStart');$('select,input,button').attr('autocomplete','off');$('#TOWNFROMINC,#STATEINC,#CHECKIN_BEG,#CHECKIN_END,#NIGHTS_FROM,#NIGHTS_TILL,#ADULT,#CHILD,#CURRENCYINC,#TOWNTO,#STARS,#HOTELS,#MEAL,#COSTMIN,#COSTMAX,#OPERATORS,#TOUR').each(function(){samo.el[this.id]=$(this);});$.event.trigger('ajaxStop');})();samo.freights_sh=function(value){var fr_obj=$('#FREIGHT');if(value>0){fr_obj.attr('checked',false);fr_obj.parent().css('display','none');}else{fr_obj.attr('checked',true);fr_obj.parent().css('display','block');}}
samo.repaint_form=function(data){for(control in data){values=data[control]
switch(control){case'INSTRUCTION':if(values==1){showSamoInstructionLink();}
break;case'TOWNFROM':case'STATE':case'CURRENCY':samo.eselect(samo.el[control+'INC'],values);break;case'CHECKIN_BEG':case'CHECKIN_END':samo.datepicker(samo.el[control],values);break;case'TOWNTO':case'STARS':case'MEAL':samo.cb(samo.el[control],values);break;case'HOTELS':samo.hotels(samo.el.HOTELS,values);break;case'NIGHTS_TILL':case'NIGHTS_FROM':case'ADULT':case'CHILD':case'COSTMIN':case'COSTMAX':samo.el[control].val(values?values:'');break;case'PRICES':samo.prices(values);break;case'OPERATORS':if(samo.el[control]){samo._select(samo.el[control],values);}
break;case'TOUR':if(samo.el[control]){samo._select(samo.el[control],values,true);if(values[0]){$('.tour_select').show();}else{$('.tour_select').hide();}}
break;case'_SETTINGS':samo._settings=values;break;default:break;}}
samo.hotels_filter();var els=$('.container td.panel:first').find('select:visible');if(els.size()>2){els.removeClass('width_long');}
els.css('width',Math.round(80/(els.size()*2))+'em');};samo.cb=function(name,items){if(items==false){items=[]}
var result=[],checked='',item=[],_checked=0;for(var i=0,length=items.length;i<length;i++){item=items[i];checked=(item.length>=3&&item[2])?'checked="checked"':'';result.push('<label><input type="checkbox" value="'+item[0]+'" '+checked+'>'+item[1]+'</label>');if(checked){_checked++;}}
name.html(result.join(''));var self=name.get(0);$.data(self,'items',items);$.data(self,'any',$('#'+self.id+'_ANY'));$($.data(self,'any')).attr('checked',!_checked);};samo._select=function(name,items,any){if(items==false){items=[];}
name.find('option').remove();if(items.length>1||any){name.append($('<option></option>').text('Все').val(0));}
$.each(items,function(i,e){var opt=$('<option></option>').text(e[1]).val(e[0]);if(e[2]==1){opt.attr('selected','selected');}
name.append(opt);});};samo.hotels=function(name,items){if(items==false){items=[];}
var result=$('<div/>'),checked='',_checked=0;$.each(items,function(idx,item){var name=item[1]+' '+item[3]+((parseInt(item[3])==item[3])?'*':'');var checked=(item.length>=6&&item[5])?'checked="checked"':'';input=$('<label><input type="checkbox" value="'+item[0]+'" '+checked+'>'+name+'</label>');items[idx].ref=input.get(0);items[idx].title=' '+item[1].toLowerCase().replace(/[^a-z0-9]/,' ');items[idx].town=item[2];items[idx].gs=item[4];result.append(input);if(checked){_checked++;}});name.empty().append(result.children());var self=name.get(0);$.data(self,'items',items);$.data(self,'any',$('#'+self.id+'_ANY'));$($.data(self,'any')).attr('checked',!_checked);};samo.datepicker=function(name,data){if(data==false){name.dpSetValidDates('0');}else{name.dpSetValidDates(data[2]).dpSetStartDate(data[1]).val(data[0]).dpSetSelected(data[0]);}};samo.eselect=function(name,items){if(items==false){items=[];}
var add=function(el,v,t,sO){var option=document.createElement("option");option.value=v,option.text=t;var o=el.options;var oL=o.length;if(!el.cache){el.cache={};for(var i=0;i<oL;i++){el.cache[o[i].value]=i;}}
if(typeof el.cache[v]=="undefined"){el.cache[v]=oL;}
el.options[el.cache[v]]=option;if(sO){option.selected=true;}};var select=name.get(0);name.find('option').remove().end().get(0).cache=null;for(var i=0,length=items.length;i<length;i++){var item=items[i]
var sel=item[2]||false;add(select,item[0],item[1],sel);}};(function(){var params={'action':'init'};if(location.search.length){$(location.search.substring(1).split('&')).each(function(){var tmp=this.split('=');if(tmp.length==2){params[tmp[0]]=tmp[1];}});}
$.each(samo.settings.search,function(i,e){if(e===null){delete samo.settings.search[i];}});params=$.extend({},samo.settings.search,params);if(params["SHOWPACKETTYPE"]&&parseInt(params["PACKETTYPE"])>=0&&parseInt(params["PACKETTYPE"])<=2){var $ptr=$('input:radio[name=PACKETTYPE]');if($ptr.is(':checked')===false){$ptr.filter('[value='+params["PACKETTYPE"]+']').attr('checked',true);samo.freights_sh(params["PACKETTYPE"]);}}else{$("td.n5").parent().css('display','none');}
$(['FREIGHT','STOPSALE']).each(function(){var $cb=$('#'+this);if(typeof params[this]!=='undefined'){$cb.attr('checked',params[this]==1);}else{params[this]=Number($cb.is(':checked'));}});$.jsonLoad(params,samo.repaint_form);})();samo.el.CHECKIN_BEG.datePicker().mask('39.19.2099');samo.el.CHECKIN_END.datePicker().mask('39.19.2099');$('#TOWNFROMINC,#STATEINC').bind('change',function(){var params={action:this.id.toLowerCase()};$('#TOWNFROMINC,#STATEINC,#NIGHTS_TILL,#NIGHTS_FROM,#ADULT,#CHILD,#CURRENCYINC,#COSTMIN,#COSTMAX,#OPERATORS').each(function(){params[this.id]=this.value;});$('#CHECKIN_BEG,#CHECKIN_END').each(function(){var tmp=this.value.split('.');params[this.id]=tmp[2]+tmp[1]+tmp[0];});$.jsonLoad(params,samo.repaint_form);});$('#OPERATORS').bind('change',function(){var params={action:'operator',OPERATORS:$(this).val(),TOWNFROMINC:$('#TOWNFROMINC').val(),STATEINC:$('#STATEINC').val()};$.jsonLoad(params,samo.repaint_form);});samo.el.CHECKIN_BEG.bind('dpClosed',function(e,selectedDates){var d=selectedDates[0];if(d){var newDate=d.asString();samo.el.CHECKIN_END.dpSetSelected(newDate).val(newDate);}}).bind('blur',function(){var newDate=this.value;samo.el.CHECKIN_END.dpSetSelected(newDate).val(newDate);});samo.el.CHECKIN_END.bind('dpClosed blur',function(){var d1=samo.el.CHECKIN_BEG.val().split('.');var d2=samo.el.CHECKIN_END.val().split('.');d1=d1[2]+d1[1]+d1[0];d2=d2[2]+d2[1]+d2[0];if(d2<d1){samo.el.CHECKIN_END.val(samo.el.CHECKIN_BEG.val());}});samo.el.NIGHTS_FROM.bind('change',function(){samo.el.NIGHTS_TILL.val(this.value);});samo.el.NIGHTS_TILL.bind('change',function(){if(parseInt(this.value)<parseInt(samo.el.NIGHTS_FROM.val())){samo.el.NIGHTS_FROM.val(this.value);}});samo.el.CHILD.bind('change',function(){if(this.value>0){$('#child_ages').css('visibility','visible');for(var $i=1;$i<=3;$i++){if($i<=this.value){$('#age_'+$i).css('visibility','visible');}else{$('#age_'+$i).css('visibility','hidden').val('');}}}else{$('#child_ages').css('visibility','hidden').find('.age').css('visibility','hidden').val('');}});$('#TOWNTO,#STARS,#MEAL,#HOTELS').delegate('input','click',function(){$('#'+$(this).parents('div:first').attr('id')+'_ANY').attr('checked',!this.checked);});$('#search_tour').delegate('.operator_redirect','click',function(){window.open(samo.datasource+$.param({action:'operator_redirect',claiminc:$(this).attr('samo:id')}));});$('#TOWNTO_ANY,#STARS_ANY,#HOTELS_ANY,#MEAL_ANY').bind('click',function(){if(this.checked){$('#'+this.id.replace('_ANY','')+' input:checked').removeAttr('checked');}});$('#hotelsearch').bind('keyup',function(e){if(e.keyCode==27){$.event.trigger('clearSearch');e.stopPropagation();return;}
$('#HOTELS_SEL').attr('checked',false);samo.hotels_filter();}).bind('clearSearch',function(){this.value='';samo.hotels_filter();});samo.reset_hotels_filter=function(){$('#TOWNTO_ANY,#STARS_ANY').each(function(){this.checked=true;var name=this.name.replace(/_ANY/,'');$('#'+name+' :checked').attr('checked',false);});$('#hotelsearch').val('');};samo.hotels_show=function(show_all){show_all=show_all||false;if(show_all){samo.hotels_filter();}else{samo.reset_hotels_filter();$('#HOTELS input').not(':checked').parent().css('display','none');$('#HOTELS input:checked').parent().css('display','block');}};$('#HOTELS_SEL').bind('click',function(){samo.hotels_show(!this.checked);});$('input:radio[name=PACKETTYPE]').bind('click',function(){samo.freights_sh(this.value);});samo.hotels_filter=function(){var $grps=[],$twns=[],$all_stars=false,$all_towns=false;$('#HOTELS_SEL').attr('checked',false);var townto_any=$('#TOWNTO_ANY').get(0);var grpstar_any=$('#STARS_ANY').get(0);var hotels=$.data(samo.el.HOTELS.get(0),'items');$('#TOWNTO input:checked').each(function(){$twns.push(parseInt(this.value));});$all_towns=townto_any.checked=!$twns.length;$('#STARS input:checked').each(function(){$grps.push(parseInt(this.value));});$all_stars=grpstar_any.checked=!$grps.length;var $filter=$.trim($('#hotelsearch').val()).toLowerCase(),$strfilter=$filter.length,hide=[],show=[];$.each(hotels,function(idx,$hotel){var found=($all_towns||$.inArray($hotel.town,$twns)!==-1);if(found&&!$all_stars){found=$.inArray($hotel.gs,$grps)!==-1;}
if(found&&$strfilter){found=$hotel.title.indexOf($filter)>0;}
$hotel.ref.style.display=(found)?'block':'none';});};$('#STARS,#TOWNTO').delegate('input','click',samo.hotels_filter);$('#STARS_ANY,#TOWNTO_ANY').bind('click',samo.hotels_filter);$('#resultset').delegate('span','click',function(){$span=$(this);if($span.is('.page')){samo.search($span.text());}
if($span.is('.bron')){window.open(samo.bronurl+'claiminc='+encodeURIComponent($span.attr('samo:id')));}});samo.prices=function(data){var pages=data[1],page=data[0],singleOperatorMode=data[3];var installments=data[4];data=data[2];if(null===singleOperatorMode){singleOperatorMode='0';}
if(null===samo._settings.SingleOperatorMode){samo._settings.SingleOperatorMode='0';}
if(singleOperatorMode!=samo._settings.SingleOperatorMode){error_msg('Для корректного отображения результатов поиска необходимо обновить страницу!',true);return;}
var $result='';if(data.length){$('.price_legend').show();var pt=$('input:radio[name=PACKETTYPE]:checked').val();var result=document.createElement('div');$(result).html(samo.result_tpl);var template=$('#eachrow',result).removeAttr('id');var container=template.parent();var show_installment=false;$.each(data,function(idx,e){var installment='';if(e[22]&&e[23]){var inst=installments[e[23]];var hint=inst.Hint?'samo:hint="'+inst.Hint.replace(/"/g,'&quot;')+'"':'';show_installment=true;installment=e[22]+' '+e[9];if(inst.Url){installment='<a href="'+inst.Url+'" target="_blank" class="installment_hint" '+hint+'>'+installment+'</a>';}else{installment='<span class="installment_hint" '+hint+'>'+installment+'</span>';}}
var row=template.clone();var tmp=row.html();var is_discount=e[18]<e[8];var priceShow=e[8];switch(samo.settings.search.PRICESHOW){case 1:case 2:priceShow=e[18];break;default:break;}
tmp=tmp.replace('{%checkin%}',e[1]).replace('{%tour%}',e[17]).replace('{%program%}',e[25]?'/ '+e[25]:'').replace('{%hotel%}',e[4]).replace('{%town%}',e[3]).replace('{%townUrl%}',e[20]).replace('%7B%townUrl%%7D',e[20]).replace('{%nights%}',e[2]).replace('{%meal%}',e[5]).replace('{%room%}',e[6]).replace('{%htplace%}',e[7]).replace('{%price%}',priceShow).replace('{%currency%}',e[9]).replace('{%touroperator%}',e[10]).replace('{%touroperatorInc%}',e[21]).replace('{%econom%}','<span class="fr_place_r p'+e[11]+'">&nbsp;</span><span class="fr_place_l p'+e[12]+'">&nbsp;</span>').replace('{%business%}','<span class="fr_place_r p'+e[13]+'">&nbsp;</span><span class="fr_place_l p'+e[14]+'">&nbsp;</span>').replace('{%installment%}',installment).replace('{%departureTimes%}',e[24]?', вылеты:<br>'+e[24]:'');row.html(tmp);if(!e[20]){row.find('a.town_url').replaceWith(row.find('a.town_url').text());}
if(e[15])row.addClass('red_row');if(e[19])row.addClass('green_row');if(e[0]){var $price=null;var _class=null;var img='<span class="price_b" alt="Бронировать тур" title="Бронировать тур">&nbsp;</span>';for(var i=0;i<2;i++){$price=$(i?'.operator_bron':'.cost',row);if($price.size()){_class=i?'operator_redirect':'bron';if(samo.settings.search.PRICESHOW!=2){$price.replaceWith('<td><span class="'+_class+'" samo:id="'+e[0]+'">'+$price.text()+img+'</span></td>');}else{$price.replaceWith('<td>'+(is_discount?'<span class="discount_old" title="Старая цена">'+e[8]+' '+e[9]+'</span>&nbsp;&nbsp;&nbsp;':'')+'<span class="'+_class+(is_discount?' discount_price':'')+'" samo:id="'+e[0]+'" '+(is_discount?' title="Цена со скидкой"':'')+'>'+$price.text()+img+'</span></td>');}}}}
container.append(row);});template.remove();if(pages.length>1){var pager='<div id="pager">';$.each(pages,function(idx,i){pager+='<span class="'+((i==page)?'current':'page')+'">'+i+'</span>&nbsp;';});pager+='<div>';$(result).append(pager);}
if(samo.settings.search.SHOWPACKETTYPE&&pt==1){$(container).parent().find('.avia').css('display','none');}
$result=result.innerHTML;}else{$result=samo.notfound_tpl;}
$('#resultset').html($result);if(samo._settings.ShowTour==1){$('.show_tour').show();}else{$('.show_tour').hide();}
if(samo._settings.ShowTo==1){$('.show_to').show();}else{$('.show_to').hide();}
if(show_installment){$('.show_installment').show();}else{$('.show_installment').hide();}};samo.showPopupHelp=function(data){var show=false;var e=samo.last_ev;var isOperatorHelp=!(typeof data=='string');if(isOperatorHelp&&samo.over_operator){var d=$('#samo_operator_help_hint');if(data.phone||data.email){if(data.phone){d.find('.help_phone').html(data.phone);d.find('.help_phone_title, .help_phone').show();}else{d.find('.help_phone_title, .help_phone').hide();}
if(data.email){d.find('.help_email').html('<a href="mailto:'+data.email+'">'+data.email+'</a>');d.find('.help_email_title, .help_email').show();}else{d.find('.help_email_title, .help_email').hide();}
d.find('.help_operator_name').text($(e.target).text());show=true;samo.operator_help_loading=false;}}else if(!isOperatorHelp){show=true;d=$('#samo_popup_hint');d.html(data);}
if(show){d.show();var o=$(e.target).offset();d.css({left:o.left+Math.round($(e.target).outerWidth()/2-d.outerWidth()/2),top:o.top-d.outerHeight()-10});if(e.target.tagName!='A'){$(e.target).css('cursor','help');}}};samo.search=function(){var page=arguments.length?arguments[0]:1;var params={action:'prices',PAGE:page};$('#TOWNFROMINC,#STATEINC,#NIGHTS_TILL,#NIGHTS_FROM,#ADULT,#CHILD,#CURRENCYINC,#COSTMIN,#COSTMAX,#OPERATORS,#TOUR').each(function(){params[this.id]=this.value;});$('#CHECKIN_BEG,#CHECKIN_END').each(function(){var tmp=this.value.split('.');params[this.id]=tmp[2]+tmp[1]+tmp[0];});$.each(['HOTELS','MEAL','TOWNTO','STARS'],function(){if((this=='TOWNTO'||this=='STARS')&&typeof params.HOTELS!='undefined'){return;}
var tmp=[];$('#'+this+' input:checked').each(function(){tmp.push(this.value);});if(tmp.length){params[this]=tmp.join(',');}
$('#FREIGHT:checked,#STOPSALE:checked').each(function(){params[this.id]=1;});});var $ages=[];$('#child_ages input.age').each(function(){if(this.value>0)$ages.push(parseInt(this.value));});params['AGES']=$ages.sort(function(a,b){return a-b}).join(',');if(samo.settings.search.SHOWPACKETTYPE){params['PACKETTYPE']=$('input[name=PACKETTYPE]:checked').val();}
$.jsonLoad(params,function(data){samo.prices(data);});};$('#load').bind('click',function(){samo.search();}).bind('ajaxStart',function(){this.disabled=true;}).bind('ajaxStop',function(){this.disabled=false;}).removeAttr('disabled');if(samo.settings.search.SHOWOPERATORSELECT){$('.show_operator_select').show();$('#TOWNFROMINC,#STATEINC,#OPERATORS').removeClass('width_long');}else{$('.show_operator_select').remove();$('#TOWNFROMINC,#STATEINC').addClass('width_long');}
$(document).delegate('.operator_help','mouseover mouseout',function(e){var d=$('#samo_operator_help_hint');if(d.size()&&$(this).attr('samo:inc')){if(e.type=='mouseover'){samo.over_operator=true;if(!samo.operator_help_loading){var params={action:'operator_help',operator:$(this).attr('samo:inc')};samo.last_ev=e;samo.operator_help_loading=true;$.jsonLoad(params,samo.showPopupHelp);}}else{$('#samo_operator_help_hint').hide();samo.over_operator=false;}}});$(document).delegate('.installment_hint','mouseover mouseout',function(e){if(e.type=='mouseover'){samo.last_ev=e;samo.showPopupHelp($(this).attr('samo:hint'));}else{$('#samo_popup_hint').hide();}});$(document).delegate('.samo_instruction_link','click',function(){if(!samo_instruction_text){$.jsonLoad({action:'instruction',AGENT:samo.uid},function(data){showSamoInstruction(data.instruction);});}});});